#!/bin/bash

# Code Box - Universal AI Coding Sandbox
# https://github.com/nezhazheng/code-box

set -e

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
IMAGE_NAME="nezhazheng/code-box:latest"
CONFIG_DIR="${HOME}/.code-box"
PORTS_FILE="${CONFIG_DIR}/ports.json"
CLAUDE_CONFIG_DIR="${HOME}/.claude"

# Resource limits
MEMORY_LIMIT="4g"
CPU_LIMIT="2"
SHM_SIZE="2g"

# Port range for random allocation
PORT_MIN=10000
PORT_MAX=60000

# Ensure config directory exists
mkdir -p "${CONFIG_DIR}"

# Initialize ports file if not exists
if [ ! -f "${PORTS_FILE}" ]; then
    echo '{}' > "${PORTS_FILE}"
fi

# Get project identifier (based on current directory)
get_project_id() {
    local dir_path=$(pwd)
    # Create a unique but readable project ID
    echo "${dir_path}" | sed 's|/|_|g' | sed 's|^_||'
}

# Get container name for current project
get_container_name() {
    local project_id=$(get_project_id)
    echo "code_box_$(basename "$(pwd)")"
}

# Check if port is available
is_port_available() {
    local port=$1
    ! lsof -i :${port} >/dev/null 2>&1
}

# Generate random available port
get_random_port() {
    local port
    local attempts=0
    while [ $attempts -lt 100 ]; do
        port=$((RANDOM % (PORT_MAX - PORT_MIN + 1) + PORT_MIN))
        if is_port_available $port; then
            echo $port
            return 0
        fi
        attempts=$((attempts + 1))
    done
    echo "Error: Could not find available port" >&2
    return 1
}

# Read port from config for project
get_saved_port() {
    local project_id=$1
    local port_type=$2  # vnc or novnc
    local port=$(cat "${PORTS_FILE}" | python3 -c "
import sys, json
data = json.load(sys.stdin)
project = data.get('$project_id', {})
print(project.get('$port_type', ''))
" 2>/dev/null)
    echo "$port"
}

# Save port to config
save_ports() {
    local project_id=$1
    local vnc_port=$2
    local novnc_port=$3

    python3 -c "
import json
with open('${PORTS_FILE}', 'r') as f:
    data = json.load(f)
data['$project_id'] = {
    'vnc': $vnc_port,
    'novnc': $novnc_port,
    'path': '$(pwd)',
    'container': '$(get_container_name)'
}
with open('${PORTS_FILE}', 'w') as f:
    json.dump(data, f, indent=2)
"
}

# Remove project from config
remove_project_ports() {
    local project_id=$1
    python3 -c "
import json
with open('${PORTS_FILE}', 'r') as f:
    data = json.load(f)
if '$project_id' in data:
    del data['$project_id']
with open('${PORTS_FILE}', 'w') as f:
    json.dump(data, f, indent=2)
"
}

# Get or allocate ports for project
get_ports() {
    local project_id=$(get_project_id)

    # Try to get saved ports
    local saved_vnc=$(get_saved_port "$project_id" "vnc")
    local saved_novnc=$(get_saved_port "$project_id" "novnc")

    # If saved ports exist and are available, use them
    if [ -n "$saved_vnc" ] && [ -n "$saved_novnc" ]; then
        if is_port_available $saved_vnc && is_port_available $saved_novnc; then
            echo "$saved_vnc $saved_novnc"
            return 0
        fi
        # Ports are in use (probably by our container), return saved ports
        echo "$saved_vnc $saved_novnc"
        return 0
    fi

    # Allocate new random ports
    local vnc_port=$(get_random_port)
    local novnc_port=$(get_random_port)

    # Make sure ports are different
    while [ "$novnc_port" == "$vnc_port" ]; do
        novnc_port=$(get_random_port)
    done

    # Save ports
    save_ports "$project_id" "$vnc_port" "$novnc_port"

    echo "$vnc_port $novnc_port"
}

# List all projects and their ports
list_projects() {
    echo -e "${CYAN}Code Box Projects:${NC}"
    echo ""
    python3 -c "
import json
with open('${PORTS_FILE}', 'r') as f:
    data = json.load(f)
if not data:
    print('  No projects registered yet.')
else:
    for project_id, info in data.items():
        print(f\"  \033[1m{info.get('container', 'unknown')}\033[0m\")
        print(f\"    Path:   {info.get('path', 'unknown')}\")
        print(f\"    VNC:    localhost:{info.get('vnc', '?')}\")
        print(f\"    noVNC:  http://localhost:{info.get('novnc', '?')}\")
        print()
"
}

# Show help
show_help() {
    echo -e "${GREEN}Code Box - Universal AI Coding Sandbox${NC}"
    echo ""
    echo "Usage: code-box [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  (no args)    Start or attach to container for current directory"
    echo "  --stop       Stop the container"
    echo "  --remove     Stop and remove the container"
    echo "  --logs       Show container logs"
    echo "  --list       List all projects and their ports"
    echo "  --clean      Remove all stopped containers and clear port registry"
    echo "  --pull       Pull latest image from Docker Hub"
    echo "  --help       Show this help message"
    echo ""
    echo -e "${YELLOW}Installed Tools:${NC}"
    echo "  Claude Code, Codex, Gemini CLI, OpenCode, oh-my-opencode"
    echo ""
    echo -e "${YELLOW}Config Directory:${NC} ${CONFIG_DIR}"
    echo -e "${YELLOW}Ports Registry:${NC}   ${PORTS_FILE}"
}

# Pull latest image
pull_image() {
    echo -e "${BLUE}Pulling latest image...${NC}"
    docker pull "${IMAGE_NAME}"
    echo -e "${GREEN}Done!${NC}"
}

# Clean up stopped containers
clean_all() {
    echo -e "${BLUE}Cleaning up stopped code-box containers...${NC}"

    # Find and remove stopped code_box containers
    local containers=$(docker ps -a --filter "name=code_box_" --filter "status=exited" -q)
    if [ -n "$containers" ]; then
        docker rm $containers
        echo -e "${GREEN}Removed stopped containers${NC}"
    else
        echo "No stopped containers to remove"
    fi

    # Clear ports registry
    echo '{}' > "${PORTS_FILE}"
    echo -e "${GREEN}Cleared ports registry${NC}"
}

# Main container operations
CONTAINER_NAME=$(get_container_name)
PROJECT_ID=$(get_project_id)

case "${1:-}" in
    --help|-h)
        show_help
        exit 0
        ;;
    --list|-l)
        list_projects
        exit 0
        ;;
    --pull)
        pull_image
        exit 0
        ;;
    --clean)
        clean_all
        exit 0
        ;;
    --stop)
        echo -e "${BLUE}Stopping container: ${CONTAINER_NAME}${NC}"
        docker stop "${CONTAINER_NAME}" 2>/dev/null || echo "Container not running"
        exit 0
        ;;
    --remove)
        echo -e "${BLUE}Removing container: ${CONTAINER_NAME}${NC}"
        docker stop "${CONTAINER_NAME}" 2>/dev/null || true
        docker rm "${CONTAINER_NAME}" 2>/dev/null || echo "Container not found"
        remove_project_ports "$PROJECT_ID"
        echo -e "${GREEN}Done!${NC}"
        exit 0
        ;;
    --logs)
        echo -e "${BLUE}Showing logs for: ${CONTAINER_NAME}${NC}"
        docker logs -f "${CONTAINER_NAME}"
        exit 0
        ;;
esac

# Get ports for this project
read VNC_PORT NOVNC_PORT <<< $(get_ports)

# Check if container already exists
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo -e "${GREEN}Container ${CONTAINER_NAME} is already running.${NC}"
        echo -e "${YELLOW}noVNC:${NC} http://localhost:${NOVNC_PORT}"
        echo -e "${YELLOW}VNC:${NC}   localhost:${VNC_PORT}"
        echo ""
        echo -e "${BLUE}Attaching to container...${NC}"
        docker exec -it "${CONTAINER_NAME}" /bin/bash
    else
        echo -e "${YELLOW}Container ${CONTAINER_NAME} exists but is stopped.${NC}"
        echo -e "${BLUE}Starting container...${NC}"
        docker start "${CONTAINER_NAME}"
        echo -e "${YELLOW}noVNC:${NC} http://localhost:${NOVNC_PORT}"
        echo -e "${YELLOW}VNC:${NC}   localhost:${VNC_PORT}"
        echo ""
        docker exec -it "${CONTAINER_NAME}" /bin/bash
    fi
else
    # Create Claude config directory if it doesn't exist
    mkdir -p "${CLAUDE_CONFIG_DIR}"

    echo -e "${GREEN}Creating new container: ${CONTAINER_NAME}${NC}"
    echo -e "${BLUE}Workspace: $(pwd)${NC}"
    echo -e "${BLUE}VNC Port:  ${VNC_PORT}${NC}"
    echo -e "${BLUE}noVNC Port: ${NOVNC_PORT}${NC}"
    echo ""

    docker run -it \
        --name "${CONTAINER_NAME}" \
        --memory="${MEMORY_LIMIT}" \
        --cpus="${CPU_LIMIT}" \
        --shm-size="${SHM_SIZE}" \
        -v "$(pwd):/home/developer/workspace" \
        -v "${CLAUDE_CONFIG_DIR}:/home/developer/.claude" \
        -p "${VNC_PORT}:5900" \
        -p "${NOVNC_PORT}:6080" \
        -e DISPLAY=:99 \
        "${IMAGE_NAME}"
fi
